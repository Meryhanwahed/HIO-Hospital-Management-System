<div *ngIf="loading" class="loading">
  โณ ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...
</div>

<div *ngIf="error" class="error">{{ error }}</div>

<!-- ุนุฑุถ ุจูุงูุงุช ุงููุฑูุถ -->
<div *ngIf="patient && !loading && !editing" class="patient-details">
  <h2>๐ค ุชูุงุตูู ุงููุฑูุถ</h2>
  <table>
    <tr><th>ุงูุงุณู</th><td>{{ patient.username }}</td></tr>
    <tr><th>ุงูุฑูู ุงููููู</th><td>{{ patient.nationalId }}</td></tr>
    <tr><th>ุงูุณู</th><td>{{ patient.age }}</td></tr>
    <tr><th>ุงูููุน</th><td>{{ patient.gender }}</td></tr>
    <tr><th>ุงููุงุชู</th><td>{{ patient.phone }}</td></tr>
    <tr><th>ุงูุนููุงู</th><td>{{ patient.address }}</td></tr>
    <tr><th>ุงููุฒู</th><td>{{ patient.weight }}</td></tr>
    <tr><th>ุงูุทูู</th><td>{{ patient.height }}</td></tr>
    <tr><th>ูุตููุฉ ุงูุฏู</th><td>{{ patient.bloodType }}</td></tr>
    <tr><th>ุงููุณู ุงูุทุจู</th><td>{{ patient.specializedMedicalDepartment }}</td></tr>
    <tr><th>ุงูุชุดุฎูุต</th><td>{{ patient.diagnosis }}</td></tr>
    <tr><th>ุงูุนุงุฏุงุช</th><td>{{ patient.habits }}</td></tr>
    <tr><th>ุงูุฃูุฑุงุถ ุงููุฒููุฉ</th><td>{{ patient.chronicDiseases }}</td></tr>
    <tr><th>ูุตู ุงูุญุงูุฉ</th><td>{{ patient.CaseDescription }}</td></tr>
    <tr><th>ูู ูุญุชุงุฌ ุฌุฑุงุญุฉุ</th><td>{{ patient.needsSurgery }}</td></tr>
    <tr><th>ุงูุนูุงุฌ</th><td>{{ patient.treatments }}</td></tr>
  </table>

  <button class="btn edit" (click)="toggleEdit()">โ ุชุนุฏูู</button>
</div>

<!-- ูููุฐุฌ ุงูุชุนุฏูู -->
<div *ngIf="editing && patientForm" class="patient-edit">
  <h2>โ ุชุนุฏูู ุจูุงูุงุช ุงููุฑูุถ</h2>

  <form [formGroup]="patientForm" (ngSubmit)="onUpdate()">
    <div class="form-group">
      <label for="username">ุงูุงุณู</label>
      <input id="username" type="text" formControlName="username">
      <small *ngIf="patientForm.get('username')?.touched && patientForm.get('username')?.invalid" class="error">
        ุงูุงุณู ูุทููุจ
      </small>
    </div>

    <div class="form-group">
      <label for="nationalId">ุงูุฑูู ุงููููู</label>
      <input id="nationalId" type="text" formControlName="nationalId">
      <small *ngIf="patientForm.get('nationalId')?.touched && patientForm.get('nationalId')?.invalid" class="error">
        ุงูุฑูู ุงููููู ุบูุฑ ุตุญูุญ
      </small>
    </div>

    <div class="form-group">
      <label for="age">ุงูุนูุฑ</label>
      <input id="age" type="number" formControlName="age">
    </div>

    <div class="form-group">
      <label for="gender">ุงูููุน</label>
      <select id="gender" formControlName="gender">
        <option value="male">ุฐูุฑ</option>
        <option value="female">ุฃูุซู</option>
      </select>
    </div>

    <div class="form-group">
      <label for="phone">ุงููุงุชู</label>
      <input id="phone" type="text" formControlName="phone">
    </div>

    <div class="form-group">
      <label for="address">ุงูุนููุงู</label>
      <input id="address" type="text" formControlName="address">
    </div>

    <div class="form-group">
      <label for="diagnosis">ุงูุชุดุฎูุต</label>
      <input id="diagnosis" type="text" formControlName="diagnosis">
    </div>

    <div class="form-group">
      <label for="doctorName">ุงุณู ุงูุทุจูุจ</label>
      <input id="doctorName" type="text" formControlName="doctorName">
    </div>

    <div class="form-group">
      <label for="doctorSpecialization">ุชุฎุตุต ุงูุทุจูุจ</label>
      <input id="doctorSpecialization" type="text" formControlName="doctorSpecialization">
    </div>

    <div class="actions">
      <button type="submit" class="btn save">๐พ ุญูุธ</button>
      <button type="button" class="btn cancel" (click)="toggleEdit()">โ ุฅูุบุงุก</button>
    </div>
  </form>
</div>

<hr>

<!-- ุฒุฑ ุฅุถุงูุฉ ุฅุญุงูุฉ -->
<button class="btn referral" (click)="toggleReferralForm()">
  {{ showReferralForm ? 'โ ุฅุบูุงู ุงูุฅุญุงูุฉ' : 'โ ุฅุถุงูุฉ ุฅุญุงูุฉ' }}
</button>

<!-- ููุฑู ุงูุฅุญุงูุฉ -->
<div *ngIf="showReferralForm">
  <app-referral-form 
    [patientId]="patient?._id || null" 
    (referralCreated)="loadReferrals()">
  </app-referral-form>
</div>

<hr>

<!-- ูุงุฆูุฉ ุงูุฅุญุงูุงุช -->
<h3>๐ ุงูุฅุญุงูุงุช ุงูุฎุงุตุฉ ุจุงููุฑูุถ</h3>
<ul *ngIf="referrals.length > 0; else noReferrals">
  <li *ngFor="let r of referrals">
    <strong>ุงููุณู:</strong> {{ r.referralToSection }} |
    <strong>ุงูุทุจูุจ:</strong> {{ r.referralTo }} |
    <strong>ุงูุณุจุจ:</strong> {{ r.reasonForReferral }}
  </li>
</ul>

<ng-template #noReferrals>
  <p>โ ูุง ุชูุฌุฏ ุฅุญุงูุงุช ููุฐุง ุงููุฑูุถ</p>
</ng-template>
